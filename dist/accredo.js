/*
Copyright (c) 2015-2019 BIZEX (NZ) LTD - All Rights Reserved
The library can not be copied and/or distributed without the express permission of BIZEX (NZ) LTD https://www.bizex.co.nz
Please contact us if you want to use the library on your projects
@author ukalpa@gmail.com
 */
module.exports=function(t){var e={};function i(s){if(e[s])return e[s].exports;var r=e[s]={i:s,l:!1,exports:{}};return t[s].call(r.exports,r,r.exports,i),r.l=!0,r.exports}return i.m=t,i.c=e,i.d=function(t,e,s){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:s})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(i.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)i.d(s,r,function(e){return t[e]}.bind(null,r));return s},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=27)}([function(t,e){t.exports=require("lodash")},function(t,e,i){"use strict";function s(t){return function(t){return t}(t)}const r={eq:s("eq"),ne:s("ne"),ge:s("ge"),gte:s("ge"),gt:s("gt"),le:s("le"),lte:s("le"),lt:s("lt"),not:s("not"),is:s("is"),in:s("in"),notIn:s("notIn"),like:s("like"),notLike:s("notLike"),iLike:s("iLike"),notILike:s("notILike"),startsWith:s("startsWith"),endsWith:s("endsWith"),substring:s("substring"),regexp:s("regexp"),notRegexp:s("notRegexp"),iRegexp:s("iRegexp"),notIRegexp:s("notIRegexp"),between:s("between"),notBetween:s("notBetween"),overlap:s("overlap"),contains:s("contains"),contained:s("contained"),adjacent:s("adjacent"),strictLeft:s("strictLeft"),strictRight:s("strictRight"),noExtendRight:s("noExtendRight"),noExtendLeft:s("noExtendLeft"),and:s("and"),or:s("or"),any:s("any"),all:s("all"),values:s("values"),col:s("col"),placeholder:s("placeholder"),join:s("join"),expand:s("expand"),select:s("select"),top:s("top"),orderby:s("orderby"),filter:s("filter")};t.exports=r},function(t,e,i){"use strict";t.exports={SELECT:"SELECT",INSERT:"INSERT",UPDATE:"UPDATE",BULKUPDATE:"BULKUPDATE",BULKDELETE:"BULKDELETE",DELETE:"DELETE",UPSERT:"UPSERT",VERSION:"VERSION",SHOWTABLES:"SHOWTABLES",SHOWINDEXES:"SHOWINDEXES",DESCRIBE:"DESCRIBE",RAW:"RAW",FOREIGNKEYS:"FOREIGNKEYS",SHOWCONSTRAINTS:"SHOWCONSTRAINTS"}},function(t,e,i){"use strict";const s=i(17).getNewLibraryCopy();t.exports=s,t.exports.Promise=s,t.exports.default=s},function(t,e,i){"use strict";e.BaseError=i(9),e.EagerLoadingError=i(18),e.ValidationError=i(19),e.ValidationErrorItem=e.ValidationError.ValidationErrorItem,e.EmptyResultError=i(20)},function(t,e){t.exports=require("util")},function(t,e,i){"use strict";const s=i(0),{logger:r}=i(11),n=i(3),a=r.debugContext("hooks"),o={beforeValidate:{params:2},afterValidate:{params:2},validationFailed:{params:3},beforeCreate:{params:2},afterCreate:{params:2},beforeDestroy:{params:2},afterDestroy:{params:2},beforeRestore:{params:2},afterRestore:{params:2},beforeUpdate:{params:2},afterUpdate:{params:2},beforeSave:{params:2,proxies:["beforeUpdate","beforeCreate"]},afterSave:{params:2,proxies:["afterUpdate","afterCreate"]},beforeUpsert:{params:2},afterUpsert:{params:2},beforeBulkCreate:{params:2},afterBulkCreate:{params:2},beforeBulkDestroy:{params:1},afterBulkDestroy:{params:1},beforeBulkRestore:{params:1},afterBulkRestore:{params:1},beforeBulkUpdate:{params:1},afterBulkUpdate:{params:1},beforeFind:{params:1},beforeFindAfterExpandIncludeAll:{params:1},beforeFindAfterOptions:{params:1},afterFind:{params:2},beforeCount:{params:1},beforeDefine:{params:2,sync:!0,noEntity:!0},afterDefine:{params:1,sync:!0,noEntity:!0},beforeInit:{params:2,sync:!0,noEntity:!0},afterInit:{params:1,sync:!0,noEntity:!0},beforeAssociate:{params:2,sync:!0},afterAssociate:{params:2,sync:!0},beforeConnect:{params:1,noEntity:!0},afterConnect:{params:2,noEntity:!0},beforeSync:{params:1},afterSync:{params:1},beforeBulkSync:{params:1},afterBulkSync:{params:1},beforeQuery:{params:2},afterQuery:{params:2}};e.hooks=o;const c=t=>o[t].proxies?o[t].proxies.concat(t):[t];function u(t,e){return(t.options.hooks||{})[e]||[]}const l={_setupHooks(t){this.options.hooks={},s.map(t||{},(t,e)=>{Array.isArray(t)||(t=[t]),t.forEach(t=>this.addHook(e,t))})},runHooks(t,...e){if(!t)throw new Error("runHooks requires at least 1 argument");let i;if("string"==typeof t&&(t=u(this,i=t),this.accredo&&(t=t.concat(u(this.accredo,i)))),Array.isArray(t)||(t=[t]),!o[i]||!o[i].sync)return n.each(t,t=>("object"==typeof t&&(t=t.fn),a(`running hook ${i}`),t.apply(this,e))).return();for(let s of t)"object"==typeof s&&(s=s.fn),a(`running hook(sync) ${i}`),s.apply(this,e)},addHook(t,e,i){return"function"==typeof e&&(i=e,e=null),a(`adding hook ${t}`),(t=c(t)).forEach(t=>{const s=u(this,t);s.push(e?{name:e,fn:i}:i),this.options.hooks[t]=s}),this},removeHook(t,e){const i="function"==typeof e;if(!this.hasHook(t))return this;a(`removing hook ${t}`),t=c(t);for(const s of t)this.options.hooks[s]=this.options.hooks[s].filter(t=>i&&"function"==typeof t?t!==e:!(!i&&"object"==typeof t)||t.name!==e);return this},hasHook(t){return this.options.hooks[t]&&!!this.options.hooks[t].length}};l.hasHooks=l.hasHook,e.applyTo=function(t,e=!1){s.mixin(t,l);for(const i of Object.keys(o))e&&o[i].noEntity||(t[i]=function(t,e){return this.addHook(i,t,e)})}},function(t,e){t.exports=require("node-fetch")},function(t,e){t.exports=require("fs")},function(t,e,i){"use strict";t.exports=class extends Error{constructor(t){super(t),this.name="AccredoBaseError",Error.captureStackTrace(this,this.constructor)}}},function(t,e){t.exports=require("dottie")},function(t,e,i){"use strict";console.log;const s=i(5);class r{constructor(t){this.config=Object.assign({context:"accredo",debug:!0},t)}warn(t){console.warn(`(${this.config.context}) Warning: ${t}`)}inspect(t){return s.inspect(t,!1,3)}debugContext(t){}}e.logger=new r,e.Logger=r},function(t,e,i){"use strict";const s=i(0),r=s.cloneDeep(i(22)),n=i(13),a={extend(t,e){return this[t]=e,this},notEmpty:t=>!t.match(/^[\s\t\r\n]*$/),len(t,e,i){return this.isLength(t,e,i)},isUrl(t){return this.isURL(t)},isIPv6(t){return this.isIP(t,6)},isIPv4(t){return this.isIP(t,4)},notIn(t,e){return!this.isIn(t,e)},regex:(t,e,i)=>(t+="","RegExp"!==Object.prototype.toString.call(e).slice(8,-1)&&(e=new RegExp(e,i)),t.match(e)),notRegex(t,e,i){return!this.regex(t,e,i)},isDecimal:t=>""!==t&&!!t.match(/^(?:-?(?:[0-9]+))?(?:\.[0-9]*)?(?:[eE][+-]?(?:[0-9]+))?$/),min(t,e){const i=parseFloat(t);return isNaN(i)||i>=e},max(t,e){const i=parseFloat(t);return isNaN(i)||i<=e},not(t,e,i){return this.notRegex(t,e,i)},contains:(t,e)=>!!e&&t.includes(e),notContains(t,e){return!this.contains(t,e)},is(t,e,i){return this.regex(t,e,i)}};e.extensions=a,r.isImmutable=function(t,e,i,s){return s.isNewRecord||s.dataValues[i]===s._previousDataValues[i]},r.notNull=function(t){return null!=t},s.forEach(a,(t,e)=>{r[e]=t}),r.isNull=r.isEmpty,r.isDate=function(t){const e=Date.parse(t);if(isNaN(e))return!1;const i=new Date(e);return n(i.toISOString()).isValid()},e.validator=r},function(t,e){t.exports=require("moment")},function(t,e,i){"use strict";const{deprecate:s}=i(5),r=()=>{};e.noRawAttributes=s(r,"Use accredo.fn / accredo.literal to construct attributes","ACCREDO0001"),e.noTrueLogging=s(r,"The logging-option should be either a function or false. Default: console.log","ACCREDO0002"),e.noStringOperators=s(r,"String based operators are deprecated. Please use Symbol based operators for better security, read more at http://docs.ACCREDOjs.com/manual/querying.html#operators","ACCREDO0003"),e.noBoolOperatorAliases=s(r,"A boolean value was passed to options.operatorsAliases. This is a no-op with v5 and should be removed.","ACCREDO0004"),e.noDoubleNestedGroup=s(r,"Passing a double nested nested array to `group` is unsupported and will be removed in v6.","ACCREDO0005")},function(t,e,i){"use strict";const s=i(26),r=i(0);class n{constructor(t){this.entities=[],this.accredo=t}addEntity(t){return this.entities.push(t),this.accredo.entities[t.name]=t,t}removeEntity(t){this.entities=this.entities.filter(e=>e.name!==t.name),delete this.accredo.entities[t.name]}getEntity(t,e){return e=r.defaults(e||{},{attribute:"name"}),this.entities.find(i=>i[e.attribute]===t)}get all(){return this.entities}forEachEntity(t,e){const i={},n=new s;let a,o;e=r.defaults(e||{},{reverse:!0});for(const t of this.entities){let e=[],s=t.getTableName();r.isObject(s)&&(s=`${s.schema}.${s.tableName}`),i[s]=t;for(const i in t.rawAttributes)if(t.rawAttributes.hasOwnProperty(i)){const s=t.rawAttributes[i];s.references&&(o=s.references.entity,r.isObject(o)&&(o=`${o.schema}.${o.tableName}`),e.push(o))}e=e.filter(t=>s!==t),n.add(s,e)}a=n.sort(),e.reverse&&(a=a.reverse());for(const e of a)t(i[e],e)}}t.exports=n,t.exports.EntityManager=n,t.exports.default=n},function(t,e){t.exports=require("path")},function(t,e){t.exports=require("bluebird")},function(t,e,i){"use strict";const s=i(9);t.exports=class extends s{constructor(t){super(t),this.name="AccredoEagerLoadingError",Error.captureStackTrace(this,this.constructor)}}},function(t,e,i){"use strict";const s=i(9);class r{constructor(t,e,i,s,n,a,o,c){if(this.message=t||"",this.type=null,this.path=i||null,this.value=void 0!==s?s:null,this.origin=null,this.instance=n||null,this.validatorKey=a||null,this.validatorName=o||null,this.validatorArgs=c||[],e)if(r.Origins[e])this.origin=e;else{const t=`${e}`.toLowerCase().trim(),i=r.TypeStringMap[t];i&&r.Origins[i]&&(this.origin=i,this.type=e)}}getValidatorKey(t,e){const i=void 0===t||!!t,s=void 0===e?".":e,n=this.origin,a=this.validatorKey||this.validatorName,o=i&&n&&r.Origins[n];if(o&&("string"!=typeof s||!s.length))throw new Error("Invalid namespace separator given, must be a non-empty string");return"string"==typeof a&&a.length?(o?[n,a].join(s):a).toLowerCase().trim():""}}r.Origins={CORE:"CORE",DB:"DB",FUNCTION:"FUNCTION"},r.TypeStringMap={"notnull violation":"CORE","string violation":"CORE","unique violation":"DB","validation error":"FUNCTION"},t.exports=class extends s{constructor(t,e){super(t),this.name="AccredoValidationError",this.message="Validation Error",this.errors=e||[],t?this.message=t:this.errors.length>0&&this.errors[0].message&&(this.message=this.errors.map(t=>`${t.type||t.origin}: ${t.message}`).join(",\n")),Error.captureStackTrace(this,this.constructor)}get(t){return this.errors.reduce((e,i)=>(i.path===t&&e.push(i),e),[])}},t.exports.ValidationErrorItem=r},function(t,e,i){"use strict";const s=i(9);t.exports=class extends s{constructor(t){super(t),this.name="AccredoEmptyResultError",Error.captureStackTrace(this,this.constructor)}}},function(t,e){t.exports=require("wkx")},function(t,e){t.exports=require("validator")},function(t,e){t.exports=require("moment-timezone")},function(t,e){t.exports=require("inflection")},function(t,e,i){"use strict";e.classToInvokable=function(t){return new Proxy(t,{apply:(t,e,i)=>new t(...i),construct:(t,e)=>new t(...e),get:(t,e)=>t[e]})}},function(t,e){t.exports=require("toposort-class")},function(t,e,i){"use strict";i.r(e);var s=i(2),r=i.n(s),n=i(0),a=i.n(n),o=i(6),c=i.n(o),u=i(4),l=i.n(u),h=i(5),d=i.n(h);i(21);const p=i(4),f=i(12).validator,y=i(23),m=i(13),{logger:g}=i(11),b={};class w{toString(t){return this.toSql(t)}toSql(){return this.key}stringify(t,e){return this._stringify?this._stringify(t,e):t}bindParam(t,e){return this._bindParam?this._bindParam(t,e):e.bindParam(this.stringify(t,e))}static toString(){return this.name}static warn(t,e){b[e]||(b[e]=!0,g.warn(`${e} \n>> Check: ${t}`))}static extend(t){return new this(t.options)}}class A extends w{constructor(t,e){super();const i="object"==typeof t&&t||{length:t,binary:e};this.options=i,this._binary=i.binary,this._length=i.length||255}toSql(){return`VARCHAR(${this._length})${this._binary?" BINARY":""}`}validate(t){if("[object String]"!==Object.prototype.toString.call(t)){if(this.options.binary&&Buffer.isBuffer(t)||"number"==typeof t)return!0;throw new p.ValidationError(d.a.format("%j is not a valid string",t))}return!0}get BINARY(){return this._binary=!0,this.options.binary=!0,this}static get BINARY(){return(new this).BINARY}}class E extends w{constructor(t={}){super(),"number"==typeof t&&(t={length:t}),this.options=t,this._length=t.length,this._zerofill=t.zerofill,this._decimals=t.decimals,this._precision=t.precision,this._scale=t.scale,this._unsigned=t.unsigned}toSql(){let t=this.key;return this._length&&(t+=`(${this._length}`,"number"==typeof this._decimals&&(t+=`,${this._decimals}`),t+=")"),this._unsigned&&(t+=" UNSIGNED"),this._zerofill&&(t+=" ZEROFILL"),t}validate(t){if(!f.isFloat(A(t)))throw new p.ValidationError(d.a.format(`%j is not a valid ${this.key.toLowerCase()}`,t));return!0}_stringify(t){return"number"==typeof t||"boolean"==typeof t||null==t?t:"function"==typeof t.toString?t.toString():t}get UNSIGNED(){return this._unsigned=!0,this.options.unsigned=!0,this}get ZEROFILL(){return this._zerofill=!0,this.options.zerofill=!0,this}static get UNSIGNED(){return(new this).UNSIGNED}static get ZEROFILL(){return(new this).ZEROFILL}}class _ extends E{validate(t){if(!f.isInt(A(t)))throw new p.ValidationError(d.a.format(`%j is not a valid ${this.key.toLowerCase()}`,t));return!0}}class v extends w{toSql(){return"TINYINT(1)"}validate(t){if(!f.isBoolean(A(t)))throw new p.ValidationError(d.a.format("%j is not a valid boolean",t));return!0}_sanitize(t){if(null!=t){Buffer.isBuffer(t)&&1===t.length&&(t=t[0]);const e=typeof t;if("string"===e)return"true"===t||"false"!==t&&t;if("number"===e)return 1===t||0!==t&&t}return t}}v.parse=v.prototype._sanitize;class O extends w{toSql(){return"DATE"}_stringify(t){return m(t).format("YYYY-MM-DD")}_sanitize(t,e){return(!e||e&&!e.raw)&&t?m(t).format("YYYY-MM-DD"):t}_isChanged(t,e){return(!e||!t||e!==t)&&!(!e&&!t&&e===t)}}const I={String:A,Byte:class extends A{},Word:class extends A{},Smallint:class extends _{},Integer:_,Float:class extends E{constructor(t,e){super("object"==typeof t&&t||{length:t,decimals:e})}validate(t){if(!f.isFloat(A(t)))throw new p.ValidationError(d.a.format("%j is not a valid float",t));return!0}},Boolean:v,Date:O,Time:class extends w{toSql(){return"TIME"}},DateTime:class extends w{constructor(t){super();const e="object"==typeof t&&t||{length:t};this.options=e,this._length=e.length||""}toSql(){return"DATETIME"}validate(t){if(!f.isDate(A(t)))throw new p.ValidationError(d.a.format("%j is not a valid date",t));return!0}_sanitize(t,e){return e&&(!e||e.raw)||t instanceof O||!t?t:new O(t)}_isChanged(t,e){return!(e&&t&&(t===e||t instanceof O&&e instanceof O&&t.getTime()===e.getTime())||!e&&!t&&e===t)}_applyTimezone(t,e){return e.timezone?y.tz.zone(e.timezone)?y(t).tz(e.timezone):m(t).utcOffset(e.timezone):y(t)}_stringify(t,e){return(t=this._applyTimezone(t,e)).format("YYYY-MM-DD HH:mm:ss.SSS Z")}},AutoInc:class extends w{},Largeint:class extends _{},Variant:class extends w{},RowID:class extends _{}};a.a.each(I,(t,e)=>{t.hasOwnProperty("key")||(t.types={},t.key=t.prototype.key=e)});var j=I;const x=i(1),k=new Set(a.a.values(x)),D={};D.dd=void 0!==console.log?console.log:function(){};D.debug=function(){process.env&&process.env.DEBUG&&console.log("* DEBUG * ",...arguments)};let S=i(24);D.classToInvokable=i(25).classToInvokable,D.useInflection=function(t){S=t},D.camelizeIf=function(t,e){let i=t;return e&&(i=R(t)),i},D.underscoredIf=function(t,e){let i=t;return e&&(i=P(t)),i},D.isPrimitive=function(t){const e=typeof t;return"string"===e||"number"===e||"boolean"===e};class T{}D.AccredoMethod=T;class N extends T{constructor(t,e){super(),this.fn=t,this.args=e}clone(){return new N(this.fn,this.args)}}D.Fn=N;D.Col=class extends T{constructor(t,...e){super(),e.length>0&&(t=e),this.col=t}};D.Cast=class extends T{constructor(t,e,i){super(),this.val=t,this.type=(e||"").trim(),this.json=i||!1}};D.Literal=class extends T{constructor(t){super(),this.val=t}};D.Json=class extends T{constructor(t,e){super(),a.a.isObject(t)?this.conditions=t:(this.path=t,e&&(this.value=e))}};function $(t){return Object.getOwnPropertySymbols(t).filter(t=>k.has(t))}function V(t){return $(t).concat(Object.keys(t))}function R(t){return t.trim().replace(/[-_\s]+(.)?/g,(t,e)=>e.toUpperCase())}function P(t){return S.underscore(t)}function C(t,e){return Array.isArray(t.attributes)&&(t.attributes=t.attributes.map(t=>"string"!=typeof t?t:e.rawAttributes[t]&&t!==e.rawAttributes[t].field?[e.rawAttributes[t].field,t]:t)),t.where&&a.a.isPlainObject(t.where)&&(t.where=q(t.where,e)),t}function q(t,e){return t&&V(t).forEach(i=>{const s=e.rawAttributes[i];s&&s.field!==s.fieldName&&(t[s.field]=t[i],delete t[i]),a.a.isPlainObject(t[i])&&(t[i]=C({where:t[i]},e).where),Array.isArray(t[i])&&t[i].forEach((s,r)=>{a.a.isPlainObject(s)&&(t[i][r]=q(s,e))})}),t}D.Where=class extends T{constructor(t,e,i){super(),void 0===i&&(i=e,e="="),this.attribute=t,this.comparator=e,this.logic=i}},D.getOperators=$,D.getComplexKeys=V,D.merge=function t(){const e={};for(const i of arguments)a.a.forOwn(i,(i,s)=>{void 0!==i&&(e[s]?a.a.isPlainObject(i)&&a.a.isPlainObject(e[s])?e[s]=t(e[s],i):Array.isArray(i)&&Array.isArray(e[s])?e[s]=i.concat(e[s]):e[s]=i:e[s]=i)});return e},D.spliceStr=function(t,e,i,s){return t.slice(0,e)+s+t.slice(e+i)},D.camelize=R,D.underscore=P,D.nameIndex=function(t,e){if(e.tableName&&(e=e.tableName),!t.hasOwnProperty("name")){const i=t.fields.map(t=>"string"==typeof t?t:t.name||t.attribute);t.name=P(`${e}_${i.join("_")}`)}return t},D.cloneDeep=function(t){return t=t||{},a.a.cloneDeepWith(t,t=>{if(!Array.isArray(t)&&!a.a.isPlainObject(t))return"object"==typeof t?t:t&&"function"==typeof t.clone?t.clone():void 0})},D.mapFinderOptions=function(t,e){return t.attributes&&Array.isArray(t.attributes)&&(t.attributes=e._injectDependentVirtualAttributes(t.attributes),t.attributes=t.attributes.filter(t=>!e._virtualAttributes.has(t))),C(t,e),t},D.mapOptionFieldNames=C,D.mapWhereFieldNames=q,D.mapValueFieldNames=function(t,e,i){const s={};for(const r of e)void 0===t[r]||i._virtualAttributes.has(r)||(i.rawAttributes[r]&&i.rawAttributes[r].field&&i.rawAttributes[r].field!==r?s[i.rawAttributes[r].field]=t[r]:s[r]=t[r]);return s},D.now=function(){const t=new Date;return t.setMilliseconds(0),t};var L=D,M=i(3),B=i.n(M),U=i(10),K=i.n(U);const F=i(12).validator;L.dd;class H{constructor(t,e){e=a.a.clone(e)||{},Array.isArray(e.fields)&&e.fields.length>0&&!e.skip&&(e.skip=a.a.difference(Object.keys(t.constructor.rawAttributes),e.fields)),this.options=a.a.defaults(e,{skip:[],hooks:!0}),this.entityInstance=t,this.validator=F,this.errors=[],this.inProgress=!1}_validate(){if(this.inProgress)throw new Error("Validations already in progress.");return this.inProgress=!0,B.a.all([this._perAttributeValidators().reflect(),this._customValidators().reflect()]).then(()=>{if(this.errors.length)throw new l.a.ValidationError(null,this.errors)})}validate(){return this.options.hooks?this._validateAndRunHooks():this._validate()}_validateAndRunHooks(){const t=this.entityInstance.constructor.runHooks.bind(this.entityInstance.constructor);return t("beforeValidate",this.entityInstance,this.options).then(()=>this._validate().catch(e=>t("validationFailed",this.entityInstance,this.options,e).then(t=>{throw t||e}))).then(()=>t("afterValidate",this.entityInstance,this.options)).return(this.entityInstance)}_perAttributeValidators(){const t=[];return a.a.forIn(this.entityInstance.rawAttributes,(e,i)=>{if(this.options.skip.includes(i))return;const s=this.entityInstance.dataValues[i];s instanceof L.AccredoMethod||(e._autoGenerated||e.autoIncrement||this._validateSchema(e,i,s),this.entityInstance.validators.hasOwnProperty(i)&&t.push(this._singleAttrValidate(s,i,e.allowNull).reflect()))}),B.a.all(t)}_customValidators(){const t=[];return a.a.each(this.entityInstance._entityOptions.validate,(e,i)=>{if(this.options.skip.includes(i))return;const s=this._invokeCustomValidator(e,i).catch(()=>{}).reflect();t.push(s)}),B.a.all(t)}_singleAttrValidate(t,e,i){if(null==t&&!i)return B.a.resolve();const s=[];return a.a.forIn(this.entityInstance.validators[e],(i,r)=>{if("isUrl"!==r&&"isURL"!==r&&"isEmail"!==r||("object"==typeof i&&null!==i&&i.msg?i={msg:i.msg}:!0===i&&(i={})),"function"==typeof i)return void s.push(this._invokeCustomValidator(i,r,!0,t,e).reflect());if(null==t)return;const n=this._invokeBuiltinValidator(t,i,r,e);n.catch(()=>{}),s.push(n.reflect())}),B.a.all(s).then(i=>this._handleReflectedResult(e,t,i))}_invokeCustomValidator(t,e,i,s,r){let n=null,a=!1;const o=t.length;let c,u=1,l=e;return i&&(u=2,c=s,l=r),o===u&&(a=!0),a?(n=i?B.a.promisify(t.bind(this.entityInstance,c)):B.a.promisify(t.bind(this.entityInstance)))().catch(t=>this._pushError(!1,l,t,s,e)):B.a.try(()=>t.call(this.entityInstance,c)).catch(t=>this._pushError(!1,l,t,s,e))}_invokeBuiltinValidator(t,e,i,s){return B.a.try(()=>{const r=String(t);if("function"!=typeof F[i])throw new Error(`Invalid validator function: ${i}`);const n=this._extractValidatorArgs(e,i,s);if(!F[i](r,...n))throw Object.assign(new Error(e.msg||`Validation ${i} on ${s} failed`),{validatorName:i,validatorArgs:n})})}_extractValidatorArgs(t,e,i){let s=t.args||t;const r="string"!=typeof s&&("isAlpha"===e||"isAlphanumeric"===e||"isMobilePhone"===e);return s=Array.isArray(s)?s.slice(0):"isImmutable"===e?[s,i,this.entityInstance]:r||"isIP"===e?[]:[s]}_validateSchema(t,e,i){if(!1===t.allowNull&&null==i){const t=this.entityInstance.validators[e],s=a.a.get(t,"notNull.msg",`${this.entityInstance.constructor.name}.${e} cannot be null`);this.errors.push(new l.a.ValidationErrorItem(s,"notNull Violation",e,i,this.entityInstance,"is_null"))}t.type instanceof j.String&&(!Array.isArray(i)&&(!a.a.isObject(i)||i instanceof L.AccredoMethod||Buffer.isBuffer(i))||this.errors.push(new l.a.ValidationErrorItem(`${e} cannot be an array or an object`,"string violation",e,i,this.entityInstance,"not_a_string")))}_handleReflectedResult(t,e,i){for(const s of i)if(s.isRejected()){const i=s.error(),r=!!i.validatorName;this._pushError(r,t,i,e,i.validatorName,i.validatorArgs)}}_pushError(t,e,i,s,r,n){const a=i.message||i||"Validation error",o=new l.a.ValidationErrorItem(a,"Validation error",e,s,this.entityInstance,r,t?r:void 0,t?n:void 0);o[H.RAW_KEY_NAME]=i,this.errors.push(o)}}H.RAW_KEY_NAME="original",H.prototype.InstanceValidator=H;var Q=H,z=i(1),W=i.n(z),G=i(14);L.dd;const Y=new Set(["where","attributes","paranoid","include","order","limit","offset","transaction","lock","raw","logging","benchmark","having","searchPath","rejectOnEmpty","plain","scope","group","through","defaults","distinct","primary","exception","type","hooks","force","name"]),J=["include","attributes","originalAttributes","order","where","limit","offset","plain","group","having"];class X{static get QueryInterface(){return this.accredo.getQueryInterface()}get accredo(){return this.constructor.accredo}constructor(t={},e={}){(e=Object.assign({isNewRecord:!0},e||{})).attributes&&(e.attributes=e.attributes.map(t=>Array.isArray(t)?t[1]:t)),e.expand&&a.a.isString(e.expand)&&(e.expand=[e.expand]),e.includeValidated||(this.constructor._conformIncludes(e,this.constructor),e.include&&(this.constructor._expandIncludeAll(e),this.constructor._validateIncludedElements(e))),this.dataValues={},this.odataValues={},this._previousDataValues={},this._changed={},this._entityOptions=this.constructor.options,this._options=e||{},this.isNewRecord=e.isNewRecord,this._initValues(t,e)}_initValues(t,e){let i,s;if(t=t&&a.a.clone(t)||{},e.isNewRecord&&(i={},this.constructor._hasDefaultValues&&(i=a.a.mapValues(this.constructor._defaultValues,t=>{const e=t();return e&&e instanceof L.AccredoMethod?e:a.a.cloneDeep(e)})),Object.keys(i).length))for(s in i)void 0===t[s]&&(this.set(s,L.toDefaultValue(i[s]),{raw:!0}),delete t[s]);this.set(t,e)}static getTableName(){return this.tableName}toString(){return`[object AccredoInstance:${this.constructor.name}]`}static init(t,e={}){if(!e.accredo)throw new Error("No Accredo instance passed");this.accredo=e.accredo;const i=this.accredo.options;(e=L.merge(a.a.cloneDeep(i.define),e)).entityName||(e.entityName=this.name),e=L.merge({name:e.entityName,indexes:[],omitNull:i.omitNull,schema:i.schema,navigations:[]},e),this.accredo.runHooks("beforeDefine",t,e),e.entityName!==this.name&&Object.defineProperty(this,"name",{value:e.entityName}),delete e.entityName,this.options=Object.assign({validate:{},paranoid:!1,rejectOnEmpty:!1,whereCollection:null,schema:null,schemaDelimiter:"",defaultScope:{},scopes:{},indexes:[]},e),this.accredo.isDefined(this.name)&&this.accredo.entityManager.removeEntity(this.accredo.entityManager.getEntity(this.name)),this.is_custom_table=!0===this.options.custom_table,this.associations={},this._setupHooks(e.hooks),this.options.tableName?this.tableName=this.options.tableName:this.tableName=this.options.tableName=this.name;const s=this.tableName;return this._schema=this.options.schema,this._schemaDelimiter=this.options.schemaDelimiter,a.a.each(e.validate,(e,i)=>{if(t.hasOwnProperty(i))throw new Error(`A entity validator function must not have the same name as a field. Entity: ${this.name}, field/validation name: ${i}`);if("function"!=typeof e)throw new Error(`Members of the validate option must be functions. Entity: ${this.name}, error with validate member ${i}`)}),this.rawAttributes=a.a.mapValues(t,(t,e)=>{if(void 0===(t=this.accredo.normalizeAttribute(t)).type)throw new Error(`Unrecognized datatype for attribute "${this.name}.${e}"`);if(!1!==t.allowNull&&a.a.get(t,"validate.notNull"))throw new Error(`Invalid definition for "${this.name}.${e}", "notNull" validator is only allowed with "allowNull:false"`);return a.a.get(t,"references.entity.prototype")instanceof X&&(t.references.entity=t.references.entity.getTableName()),t}),this._indexes=this.options.indexes.map(t=>L.nameIndex(this._conformIndex(t),s)),this.primaryKeys={},this._readOnlyAttributes=new Set,this._expands=new Set(this.options.navigations.map(t=>"object"==typeof t?t.Name:t)),this._hasReadOnlyAttributes=this._readOnlyAttributes.size>0,this._addDefaultAttributes(),this.refreshAttributes(),this._findAutoIncrementAttribute(),this._scope=this.options.defaultScope,this._scopeNames=["defaultScope"],this.accredo.entityManager.addEntity(this),this.accredo.runHooks("afterDefine",this),this}static _conformIndex(t){if(!t.fields)throw new Error('Missing "fields" property for index definition');return(t=a.a.defaults(t,{type:"",parser:null})).type&&"unique"===t.type.toLowerCase()&&(t.unique=!0,delete t.type),t}static _addDefaultAttributes(){let t={};if(!a.a.some(this.rawAttributes,"primaryKey")){if("id"in this.rawAttributes)throw new Error(`A column called 'id' was added to the attributes of '${this.tableName}' but not marked with 'primaryKey: true'`);t={id:{type:new j.Integer,allowNull:!1,primaryKey:!0,autoIncrement:!0,_autoGenerated:!0}}}const e=a.a.clone(this.rawAttributes);this.rawAttributes={},a.a.each(t,(t,e)=>{this.rawAttributes[e]=t}),a.a.each(e,(t,e)=>{this.rawAttributes[e]=t}),a.a.each({},(t,e)=>{void 0===this.rawAttributes[e]&&(this.rawAttributes[e]=t)}),Object.keys(this.primaryKeys).length||(this.primaryKeys.id=this.rawAttributes.id)}static _findAutoIncrementAttribute(){this.autoIncrementAttribute=null;for(const t in this.rawAttributes)if(this.rawAttributes.hasOwnProperty(t)){const e=this.rawAttributes[t];if(e&&e.autoIncrement){if(this.autoIncrementAttribute)throw new Error("Invalid Instance definition. Only one autoincrement field allowed.");this.autoIncrementAttribute=t}}}static refreshAttributes(){const t={};this.prototype._customGetters={},this.prototype._customSetters={},["get","set"].forEach(e=>{const i=`${e}terMethods`,s=a.a.clone(a.a.isObject(this.options[i])?this.options[i]:{}),r="get"===e?this.prototype._customGetters:this.prototype._customSetters;a.a.each(s,(t,i)=>{r[i]=t,"get"===e&&(s[i]=function(){return this.get(i)}),"set"===e&&(s[i]=function(t){return this.set(i,t)})}),a.a.each(this.rawAttributes,(t,i)=>{t.hasOwnProperty(e)&&(r[i]=t[e]),"get"===e&&(s[i]=function(){return this.get(i)}),"set"===e&&(s[i]=function(t){return this.set(i,t)})}),Array.isArray(this.options.navigations)&&a.a.each(this.options.navigations,t=>{const i="object"==typeof t?t.Name:t;"get"===e&&(s[i]=function(){return this.get(i)}),"set"===e&&(s[i]=function(t){return this.set(i,t)})}),a.a.each(s,(i,s)=>{t[s]||(t[s]={configurable:!0}),t[s][e]=i})}),this._dataTypeChanges={},this._dataTypeSanitizers={},this._jsonAttributes=new Set,this._virtualAttributes=new Set,this._defaultValues={},this.prototype.validators={},this.fieldRawAttributesMap={},this.primaryKeys={},this.uniqueKeys={},a.a.each(this.rawAttributes,(t,e)=>{if(t.type=this.accredo.normalizeDataType(t.type),t.Entity=this,t.fieldName=e,t._entityAttribute=!0,void 0===t.field&&(t.field=e),!0===t.primaryKey&&(this.primaryKeys[e]=t),this.fieldRawAttributesMap[t.field]=t,t.type._sanitize&&(this._dataTypeSanitizers[e]=t.type._sanitize),t.type._isChanged&&(this._dataTypeChanges[e]=t.type._isChanged),t.type instanceof j.Boolean?this._hasBooleanAttributes=!0:(t.type instanceof j.Date||t.type instanceof j.DateTime)&&(this._hasDateAttributes=!0),t.hasOwnProperty("defaultValue")&&(this._defaultValues[e]=()=>L.toDefaultValue(t.defaultValue)),t.hasOwnProperty("unique")&&t.unique){let i;i="object"==typeof t.unique&&t.unique.hasOwnProperty("name")?t.unique.name:"string"==typeof t.unique?t.unique:`${this.tableName}_${e}_unique`;const s=this.uniqueKeys[i]||{fields:[]};s.fields.push(t.field),s.msg=s.msg||t.unique.msg||null,s.name=i||!1,s.column=e,s.customIndex=!0!==t.unique,this.uniqueKeys[i]=s}t.hasOwnProperty("validate")&&(this.prototype.validators[e]=t.validate)}),this.fieldAttributeMap=a.a.reduce(this.fieldRawAttributesMap,(t,e,i)=>(i!==e.fieldName&&(t[i]=e.fieldName),t),{}),this._hasJsonAttributes=!!this._jsonAttributes.size,this._hasVirtualAttributes=!!this._virtualAttributes.size,this._hasDefaultValues=!a.a.isEmpty(this._defaultValues),this.tableAttributes=a.a.omitBy(this.rawAttributes,(t,e)=>this._virtualAttributes.has(e)),this.prototype._hasCustomGetters=Object.keys(this.prototype._customGetters).length,this.prototype._hasCustomSetters=Object.keys(this.prototype._customSetters).length;for(const e of Object.keys(t))X.prototype.hasOwnProperty(e)?this.accredo.log(`Not overriding built-in method from entity attribute: ${e}`):Object.defineProperty(this.prototype,e,t[e]);this.prototype.rawAttributes=this.rawAttributes,this.prototype._isAttribute=t=>this.prototype.rawAttributes.hasOwnProperty(t),this.primaryKeyAttributes=Object.keys(this.primaryKeys),this.primaryKeyAttribute=this.primaryKeyAttributes[0],this.primaryKeyAttribute&&(this.primaryKeyField=this.rawAttributes[this.primaryKeyAttribute].field||this.primaryKeyAttribute),this._hasPrimaryKeys=this.primaryKeyAttributes.length>0,this._isPrimaryKey=t=>this.primaryKeyAttributes.includes(t)}set(t,e,i){let s,r;if("object"==typeof t&&null!==t){if(s=t,(i=e||{}).reset){this.dataValues={};for(const t in s)this.changed(t,!1);this.odataValues={}}if(!i.raw||this._options&&this._options.include||i&&i.attributes||this.constructor._hasDateAttributes||this.constructor._hasBooleanAttributes){if(i.attributes){const t=t=>{for(const e of t)void 0!==s[e]&&this.set(e,s[e],i)};t(i.attributes),this.constructor._hasVirtualAttributes&&t(this.constructor._virtualAttributes),this._options.includeNames&&t(this._options.includeNames),(t=>{for(const e of t)void 0!==s[e]&&(this.odataValues[e]=s[e])})(["@odata.id","@odata.etag","@odata.editLink"])}else for(const t in s)this.set(t,s[t],i);i.raw&&(this._previousDataValues=a.a.clone(this.dataValues)),Array.isArray(i.expand)&&i.expand.length>0&&this.constructor._expands.size>0&&i.expand.map(t=>{this.constructor._expands.has(t)&&this.set(t,s[t]?s[t]:[],i)})}else Object.keys(this.dataValues).length?this.dataValues=Object.assign(this.dataValues,s):this.dataValues=s,this._previousDataValues=a.a.clone(this.dataValues);return this}if(i||(i={}),i.raw||(r=this.dataValues[t]),!i.raw&&this._customSetters[t]){this._customSetters[t].call(this,e,t);const i=this.dataValues[t];(!L.isPrimitive(i)&&null!==i||i!==r)&&(this._previousDataValues[t]=r,this.changed(t,!0))}else{if(this._options&&this._options.include&&this._options.includeNames.includes(t))return this._setInclude(t,e,i),this;if(!i.raw){if(!this._isAttribute(t)){if(t.includes(".")&&this.constructor._jsonAttributes.has(t.split(".")[0])){const i=K.a.get(this.dataValues,t);a.a.isEqual(i,e)||(K.a.set(this.dataValues,t,e),this.changed(t.split(".")[0],!0))}if(!Array.isArray(this._options.expand)||!this._options.expand.includes(t))return this}if(this.constructor._hasPrimaryKeys&&r&&this.constructor._isPrimaryKey(t))return this;if(!this.isNewRecord&&this.constructor._hasReadOnlyAttributes&&this.constructor._readOnlyAttributes.has(t))return this}e instanceof L.AccredoMethod||!this.constructor._dataTypeSanitizers.hasOwnProperty(t)||(e=this.constructor._dataTypeSanitizers[t].call(this,e,i)),!i.raw&&(e instanceof L.AccredoMethod||!(e instanceof L.AccredoMethod)&&this.constructor._dataTypeChanges[t]&&this.constructor._dataTypeChanges[t].call(this,e,r,i)||!this.constructor._dataTypeChanges[t]&&(!L.isPrimitive(e)&&null!==e||e!==r))&&(this._previousDataValues[t]=r,this.changed(t,!0)),this.dataValues[t]=e}return this}previous(t){return t?this._previousDataValues[t]:a.a.pickBy(this._previousDataValues,(t,e)=>this.changed(e))}_setInclude(t,e,i){Array.isArray(e)||(e=[e]),e[0]instanceof X&&(e=e.map(t=>t.dataValues));const s=this._options.includeMap[t],r=s.association,n=t,a=s.entity.primaryKeyAttribute;let o,c;c||(o={isNewRecord:this.isNewRecord,include:s.include,includeNames:s.includeNames,includeMap:s.includeMap,includeValidated:!0,raw:i.raw,attributes:s.originalAttributes}),(void 0===s.originalAttributes||s.originalAttributes.length)&&(r.isSingleAssociation?(Array.isArray(e)&&(e=e[0]),c=e&&null===e[a]||null===e,this[n]=this.dataValues[n]=c?null:s.entity.build(e,o)):(c=e[0]&&null===e[0][a],this[n]=this.dataValues[n]=c?[]:s.entity.bulkBuild(e,o)))}changed(t,e){if(t)return void 0!==e?(this._changed[t]=e,this):this._changed[t]||!1;const i=Object.keys(this.dataValues).filter(t=>this.changed(t));return!!i.length&&i}static getAvailableExpands(t=!1){return Array.isArray(this.options.navigations)?t?this.options.navigations:this.options.navigations.map(t=>t.Name):[]}static find(t,e){return"object"==typeof t?this.findAll(t,e):this.findByPk(t,e)}static findByPk(t,e){if([null,void 0].includes(t))return B.a.resolve(null);if(e=L.cloneDeep(e)||{},"number"!=typeof t&&"string"!=typeof t&&!Buffer.isBuffer(t))throw new Error(`Argument passed to findByPk is invalid: ${t}`);return e.where={[this.primaryKeyAttribute]:t},this.findOne(e)}static findOne(t){if(void 0!==t&&!a.a.isPlainObject(t))throw new Error("The argument passed to findOne must be an options object, use findByPk if you wish to pass a single primary key value");if(void 0===(t=L.cloneDeep(t)).limit){const e=a.a.chain(this.uniqueKeys).values().filter(t=>1===t.fields.length).map("column").value();t.where&&a.a.some(t.where,(t,i)=>(i===this.primaryKeyAttribute||e.includes(i))&&(L.isPrimitive(t)||Buffer.isBuffer(t)))||(t.limit=1)}return this.findAll(a.a.defaults(t,{plain:!0}))}static aggregate(t,e,i){const s=(i=L.cloneDeep(i)).attributes;i.attributes=s,this._conformIncludes(i,this),i.include&&(this._expandIncludeAll(i),this._validateIncludedElements(i));const r=this.rawAttributes[t],n=r&&r.field||t;let o=this.accredo.col(n);i.distinct&&(o=this.accredo.fn("DISTINCT",o));let{group:c}=i;return Array.isArray(c)&&Array.isArray(c[0])&&(Object(G.noDoubleNestedGroup)(),c=a.a.flatten(c)),i.attributes=a.a.unionBy(i.attributes,c,[[this.accredo.fn(e,o),e]],t=>Array.isArray(t)?t[1]:t),i.dataType?i.dataType=this.accredo.normalizeDataType(i.dataType):i.dataType=r?r.type:new j.Float,L.mapOptionFieldNames(i,this),this.QueryInterface.rawSelect(this,i,e).then(t=>null===t?0:t)}static async count(t){return await this.QueryInterface.count(this,t)}static findAndCountAll(t){if(void 0!==t&&!a.a.isPlainObject(t))throw new Error("The argument passed to findAndCountAll must be an options object, use findByPk if you wish to pass a single primary key value");const e=L.cloneDeep(t);return e.attributes&&(e.attributes=void 0),B.a.all([this.count(e),this.findAll(t)]).then(([t,e])=>({count:t,rows:0===t?[]:e}))}static async findAll(t){if(void 0!==t&&!a.a.isPlainObject(t))throw new l.a.QueryError("The argument passed to findAll must be an options object, use findByPk if you wish to pass a single primary key value");if(void 0!==t&&t.attributes&&!Array.isArray(t.attributes)&&!a.a.isPlainObject(t.attributes))throw new l.a.QueryError("The attributes option must be an array of column names or an object");this.warnOnInvalidOptions(t,Object.keys(this.rawAttributes));const e={};let i;e[this.getTableName(t)]=!0,(t=L.cloneDeep(t)).expand&&a.a.isString(t.expand)&&(t.expand=[t.expand]),a.a.defaults(t,{hooks:!0}),t.rejectOnEmpty=t.hasOwnProperty("rejectOnEmpty")?t.rejectOnEmpty:this.options.rejectOnEmpty,t.hooks&&await this.runHooks("beforeFind",t),this._conformIncludes(t,this),this._expandAttributes(t),this._expandIncludeAll(t),t.hooks&&await this.runHooks("beforeFindAfterExpandIncludeAll",t),t.originalAttributes=this._injectDependentVirtualAttributes(t.attributes),t.include&&(t.hasJoin=!0,this._validateIncludedElements(t,e),!t.attributes||t.raw||!this.primaryKeyAttribute||t.attributes.includes(this.primaryKeyAttribute)||t.group&&t.hasSingleAssociation&&!t.hasMultiAssociation||(t.attributes=[this.primaryKeyAttribute].concat(t.attributes))),t.attributes||(t.attributes=Object.keys(this.rawAttributes),t.originalAttributes=this._injectDependentVirtualAttributes(t.attributes)),this.options.whereCollection=t.where||null,L.mapFinderOptions(t,this),t.hooks&&await this.runHooks("beforeFindAfterOptions",t),i=L.cloneDeep(t),t.tableNames=Object.keys(e);const s=await this.QueryInterface.select(this,t);if(t.hooks&&await this.runHooks("afterFind",s,t),a.a.isEmpty(s)&&t.rejectOnEmpty){if("function"==typeof t.rejectOnEmpty)throw new t.rejectOnEmpty;if("object"==typeof t.rejectOnEmpty)throw t.rejectOnEmpty;throw new l.a.EmptyResultError}return await X._findSeparate(s,i)}static async _findSeparate(t,e){if(!e.include||e.raw||!t)return t;const i=t;return e.plain&&(t=[t]),t.length?B.a.map(e.include,i=>i.separate?i.association.get(t,Object.assign({},a.a.omit(e,J),a.a.omit(i,["parent","association","as","originalAttributes"]))).then(e=>{for(const s of t)s.set(i.association.as,e[s.get(i.association.sourceKey)],{raw:!0})}):X._findSeparate(t.reduce((t,e)=>{let s=e.get(i.association.as);if(!s)return t;Array.isArray(s)||(s=[s]);for(let e=0,i=s.length;e!==i;++e)t.push(s[e]);return t},[]),Object.assign({},a.a.omit(e,"include","attributes","order","where","limit","offset","plain","scope"),{include:i.include||[]}))).return(i):i}static _validateIncludedElements(t,e){t.entity||(t.entity=this),e=e||{},t.includeNames=[],t.includeMap={},t.hasSingleAssociation=!1,t.hasMultiAssociation=!1,t.parent||(t.topEntity=t.entity,t.topLimit=t.limit),t.include=t.include.map(i=>((i=this._conformInclude(i)).parent=t,i.topLimit=t.topLimit,this._validateIncludedElement.call(t.entity,i,e,t),void 0===i.duplicating&&(i.duplicating=i.association.isMultiAssociation),i.hasDuplicating=i.hasDuplicating||i.duplicating,i.hasRequired=i.hasRequired||i.required,t.hasDuplicating=t.hasDuplicating||i.hasDuplicating,t.hasRequired=t.hasRequired||i.required,t.hasWhere=t.hasWhere||i.hasWhere||!!i.where,i));for(const e of t.include)e.hasParentWhere=t.hasParentWhere||!!t.where,e.hasParentRequired=t.hasParentRequired||!!t.required,!1!==e.subQuery&&t.hasDuplicating&&t.topLimit?e.duplicating?(e.subQuery=!1,e.subQueryFilter=e.hasRequired):(e.subQuery=e.hasRequired,e.subQueryFilter=!1):(e.subQuery=e.subQuery||!1,e.duplicating?(e.subQueryFilter=e.subQuery,e.subQuery=!1):(e.subQueryFilter=!1,e.subQuery=e.subQuery||e.hasParentRequired&&e.hasRequired)),t.includeMap[e.as]=e,t.includeNames.push(e.as),t.topEntity===t.entity&&void 0===t.subQuery&&t.topLimit&&(e.subQuery?t.subQuery=e.subQuery:e.hasDuplicating&&(t.subQuery=!0)),t.hasIncludeWhere=t.hasIncludeWhere||e.hasIncludeWhere||!!e.where,t.hasIncludeRequired=t.hasIncludeRequired||e.hasIncludeRequired||!!e.required,(e.association.isMultiAssociation||e.hasMultiAssociation)&&(t.hasMultiAssociation=!0),(e.association.isSingleAssociation||e.hasSingleAssociation)&&(t.hasSingleAssociation=!0);return t.topEntity===t.entity&&void 0===t.subQuery&&(t.subQuery=!1),t}static _validateIncludedElement(t,e,i){if(e[t.entity.getTableName()]=!0,t.attributes&&!i.raw?(t.entity._expandAttributes(t),t.originalAttributes=this._injectDependentVirtualAttributes(t.attributes),(t=L.mapFinderOptions(t,t.entity)).attributes.length&&a.a.each(t.entity.primaryKeys,(e,i)=>{t.attributes.some(t=>e.field!==i?Array.isArray(t)&&t[0]===e.field&&t[1]===i:t===i)||t.attributes.unshift(i)})):t=L.mapFinderOptions(t,t.entity),t._pseudo)return t.attributes=Object.keys(t.entity.tableAttributes),L.mapFinderOptions(t,t.entity);const s=t.association||this._getIncludedAssociation(t.entity,t.as);if(t.association=s,t.as=s.as,t.association.through&&Object(t.association.through.entity)===t.association.through.entity){t.include||(t.include=[]);const i=t.association.through;t.through=a.a.defaults(t.through||{},{entity:i.entity,as:i.entity.name,association:{isSingleAssociation:!0},_pseudo:!0,parent:t}),i.scope&&(t.through.where=t.through.where?{[W.a.and]:[t.through.where,i.scope]}:i.scope),t.include.push(t.through),e[i.tableName]=!0}let r;if(r=!0===t.entity.scoped?t.entity:t.association.target.name===t.entity.name?t.association.target:t.association.source,t.attributes||(t.attributes=Object.keys(t.entity.tableAttributes)),void 0===(t=L.mapFinderOptions(t,t.entity)).required&&(t.required=!!t.where),t.association.scope&&(t.where=t.where?{[W.a.and]:[t.where,t.association.scope]}:t.association.scope),t.limit&&void 0===t.separate&&(t.separate=!0),!0===t.separate){if(!(t.association instanceof HasMany))throw new Error("Only HasMany associations support include.separate");t.duplicating=!1,i.attributes&&i.attributes.length&&!a.a.flattenDepth(i.attributes,2).includes(s.sourceKey)&&i.attributes.push(s.sourceKey),t.attributes&&t.attributes.length&&!a.a.flattenDepth(t.attributes,2).includes(s.foreignKey)&&t.attributes.push(s.foreignKey)}return t.hasOwnProperty("include")&&this._validateIncludedElements.call(t.entity,t,e),t}static _injectDependentVirtualAttributes(t){if(!this._hasVirtualAttributes)return t;if(!t||!Array.isArray(t))return t;for(const e of t)this._virtualAttributes.has(e)&&this.rawAttributes[e].type.fields&&(t=t.concat(this.rawAttributes[e].type.fields));return t=a.a.uniq(t)}static _conformInclude(t,e){if(t){let i;if(t._pseudo)return t;if((t=this._transformStringAssociation(t,e))instanceof Association)return{entity:i=e&&t.target.name===e.name?t.source:t.target,association:t,as:t.as};if(t.prototype&&t.prototype instanceof X)return{entity:t};if(a.a.isPlainObject(t)){if(t.association)return t.association=this._transformStringAssociation(t.association,e),i=e&&t.association.target.name===e.name?t.association.source:t.association.target,t.entity||(t.entity=i),t.as||(t.as=t.association.as),this._conformIncludes(t,i),t;if(t.entity)return this._conformIncludes(t,t.entity),t;if(t.all)return this._conformIncludes(t),t}}throw new Error("Include unexpected. Element has to be either a Entity, an Association or an object.")}static _conformIncludes(t,e){if(t.include){if(Array.isArray(t.include)){if(!t.include.length)return void delete t.include}else t.include=[t.include];t.include=t.include.map(t=>this._conformInclude(t,e))}}static _expandAttributes(t){if(!a.a.isPlainObject(t.attributes))return;let e=Object.keys(this.rawAttributes);t.attributes.exclude&&(e=e.filter(e=>!t.attributes.exclude.includes(e))),t.attributes.include&&(e=e.concat(t.attributes.include)),t.attributes=e}static _expandIncludeAll(t){const e=t.include;if(e){for(let t=0;t<e.length;t++){const i=e[t];i.all&&(e.splice(t,1),t--,this._expandIncludeAllElement(e,i))}e.forEach(t=>{this._expandIncludeAll.call(t.entity,t)})}}static _expandIncludeAllElement(t,e){let i=e.all;if(delete e.all,!0!==i){Array.isArray(i)||(i=[i]);const t={BelongsTo:!0,HasOne:!0,HasMany:!0,One:["BelongsTo","HasOne"],Has:["HasOne","HasMany"],Many:["HasMany"]};for(let e=0;e<i.length;e++){const s=i[e];if("All"===s){i=!0;break}const r=t[s];if(!r)throw new l.a.EagerLoadingError(`include all '${s}' is not valid - must be BelongsTo, HasOne, HasMany, One, Has, Many or All`);if(!0!==r){i.splice(e,1),e--;for(let t=0;t<r.length;t++)i.includes(r[t])||(i.unshift(r[t]),e++)}}}const s=e.nested;s&&(delete e.nested,e.include?Array.isArray(e.include)||(e.include=[e.include]):e.include=[]);const r=[];!function t(n,o){a.a.forEach(n.associations,c=>{if(!0!==i&&!i.includes(c.associationType))return;const u=c.target,l=c.options.as,h={entity:u};if(l&&(h.as=l),a.a.some(o,h))return;if(s&&r.includes(u))return;r.push(n);const d=L.cloneDeep(e);d.entity=u,l&&(d.as=l),o.push(d),s&&(t(u,d.include),0===d.include.length&&delete d.include)}),r.pop()}(this,t)}static warnOnInvalidOptions(t,e){if(!a.a.isPlainObject(t))return;const i=Object.keys(t).filter(t=>!Y.has(t)),s=a.a.intersection(i,e);!t.where&&s.length>0&&logger.warn(`Entity attributes (${s.join(", ")}) passed into finder method options of entity ${this.name}, but the options.where object is empty. Did you forget to use options.where?`)}static build(t,e){return Array.isArray(t)?this.bulkBuild(t,e):new this(t,e)}static bulkBuild(t,e){return(e=Object.assign({isNewRecord:!0},e||{})).includeValidated||(this._conformIncludes(e,this),e.include&&(this._expandIncludeAll(e),this._validateIncludedElements(e))),e.attributes&&(e.attributes=e.attributes.map(t=>Array.isArray(t)?t[1]:t)),t.map(t=>this.build(t,e))}toJSON(){return a.a.cloneDeep(this.get({plain:!0}))}toJson(){return this.toJSON()}toString(){return`[object AccredoInstance:${this.constructor.name}]`}getDataValue(t){return this.dataValues[t]}setDataValue(t,e){const i=this._previousDataValues[t];(!L.isPrimitive(e)&&null!==e||e!==i)&&this.changed(t,!0),this.dataValues[t]=e}get(t,e){if(void 0===e&&"object"==typeof t&&(e=t,t=void 0),e=e||{},t)return this._customGetters.hasOwnProperty(t)&&!e.raw?this._customGetters[t].call(this,t,e):e.plain&&this._options.include&&this._options.includeNames.includes(t)?Array.isArray(this.dataValues[t])?this.dataValues[t].map(t=>t.get(e)):this.dataValues[t]instanceof X?this.dataValues[t].get(e):this.dataValues[t]:this.dataValues[t];if(this._hasCustomGetters||e.plain&&this._options.include||e.clone){const t={};let i;if(this._hasCustomGetters)for(i in this._customGetters)this._options.attributes&&!this._options.attributes.includes(i)||this._customGetters.hasOwnProperty(i)&&(t[i]=this.get(i,e));for(i in this.dataValues)!t.hasOwnProperty(i)&&this.dataValues.hasOwnProperty(i)&&(t[i]=this.get(i,e));return t}return this.dataValues}async save(t){if(arguments.length>1)throw new Error("The second argument was removed in favor of the options object.");t=L.cloneDeep(t),(t=a.a.defaults(t,{hooks:!0,validate:!0})).fields||(this.isNewRecord?t.fields=Object.keys(this.constructor.rawAttributes):t.fields=a.a.intersection(this.changed(),Object.keys(this.constructor.rawAttributes)),Array.isArray(this._options.expand)&&(t.fields=t.fields.concat(this._options.expand)),t.defaultFields=t.fields),void 0===t.returning&&(t.association?t.returning=!1:this.isNewRecord&&(t.returning=!0));const e=this.constructor.primaryKeyAttribute,i=e&&this.constructor.rawAttributes[e],s=this.isNewRecord?"Create":"Update",r=this.isNewRecord;L.now();if(!0===this.isNewRecord&&i&&i.defaultValue&&!t.fields.includes(e)&&t.fields.unshift(e),!1===this.isNewRecord&&e&&void 0===this.get(e,{raw:!0}))throw new Error("You attempted to save an instance with no primary key, this is not allowed since it would result in a global update");if(t.validate&&await this.validate(t),t.hooks){const e=a.a.pick(this.dataValues,t.fields);let i,r=a.a.difference(this.changed(),t.fields),n=[];if(await this.constructor.runHooks(`before${s}`,this,t),t.defaultFields&&!this.isNewRecord){i=a.a.pick(this.dataValues,a.a.difference(this.changed(),r)),n=[];for(const t of Object.keys(i))i[t]!==e[t]&&n.push(t);t.fields=a.a.uniq(t.fields.concat(n))}n.length>0&&t.validate&&(t.skip=a.a.difference(Object.keys(this.constructor.rawAttributes),n),await this.validate(t).then(()=>{delete t.skip}))}if(!t.fields.filter(t=>!this.constructor._virtualAttributes.has(t)).length)return this;if(!this.changed()&&!this.isNewRecord)return this;let n=L.mapValueFieldNames(this.dataValues,t.fields,this.constructor),o=null,c=[];r?(null===n[e]&&delete n[e],o="insert",c=[this,n,t]):(o="update",c=[this,n,t]);const u=this.constructor;let l=(await u.QueryInterface[o](...c))[u.primaryKeyAttribute];if(u.rawAttributes[u.primaryKeyAttribute].type instanceof j.Integer&&"string"==typeof l&&(l=parseInt(l)),!r&&this.getPrimaryKey()!==l)throw new Error("Primary Key inconsistency before("+l+") and after update("+this.getPrimaryKey()+"). ");const h={};this._options.expand&&(h.expand=this._options.expand);let d=await u.findByPk(l,h);this.setODataValues(d.getODataValues());for(const t of Object.keys(this.constructor.rawAttributes))this.constructor.rawAttributes[t].field&&void 0!==n[this.constructor.rawAttributes[t].field]&&this.constructor.rawAttributes[t].field!==t&&(n[t]=n[this.constructor.rawAttributes[t].field],delete n[this.constructor.rawAttributes[t].field]);n=Object.assign(n,d.dataValues),this.dataValues=Object.assign(this.dataValues,n),t.hooks&&await this.constructor.runHooks(`after${s}`,this,t);for(const e of t.fields)this._previousDataValues[e]=this.dataValues[e],this.changed(e,!1);return this.isNewRecord=!1,d=null,this}validate(t){return new Q(this,t).validate()}where(t){const e=this.constructor.primaryKeyAttributes.reduce((t,e)=>(t[e]=this.get(e,{raw:!0}),t),{});return 0===a.a.size(e)?this._entityOptions.whereCollection:L.mapWhereFieldNames(e,this.constructor)}getPrimaryKeyAttribute(){return this.constructor.rawAttributes[this.constructor.primaryKeyAttribute]}getPrimaryKey(){return this.get(this.constructor.primaryKeyAttribute)}setODataValues(t){this.odataValues=t}getODataValues(){return this.odataValues}getODataValue(t){return this.odataValues["@odata."+t]}setODataValue(t,e){this.odataValues["@odata."+t]=e}async delete(t){(t=Object.assign({hooks:!0,force:!1},t)).hooks&&await this.constructor.runHooks("beforeDestroy",this,t);const e=await this.constructor.QueryInterface.delete(this,t);return t.hooks&&await this.constructor.runHooks("afterDestroy",this,t),e[this.constructor.primaryKeyAttribute]===this.getPrimaryKey()}static create(t,e){return e=L.cloneDeep(e||{}),this.build(t,{isNewRecord:!0,attributes:e.fields,include:e.include,raw:e.raw,silent:e.silent,expand:e.expand||[]}).save(e)}}c.a.applyTo(X),c.a.applyTo(X.prototype);var Z=i(15),tt=i.n(Z);console.log;const et=[W.a.eq,W.a.ne,W.a.gt,W.a.ge,W.a.lt,W.a.le,W.a.like],it=[W.a.and,W.a.or,W.a.not],st=[W.a.any,W.a.all],rt=[W.a.startsWith,W.a.endsWith,W.a.contains],nt=[W.a.expand,W.a.select,W.a.top,W.a.orderby,W.a.filter],at=/\((.*)\)/;var ot=function(t){let{filter:e,where:i,limit:s,count:r,order:n,attributes:o,expand:c}=t;const u={};if(i=Object.assign({},i,e)){const t=ct(i);t&&(u.$filter=t)}if(s){const t=function(t){return a.a.isInteger(t)&&t>0&&t}(s);t&&(u.$top=t)}if(Array.isArray(o)&&o.length>0){const t=function(t){return t.join(",")}(o);t&&(u.$select=t)}if(n){const t=lt(n);t&&(u.$orderby=t)}if(c){const t=function t(e){if("number"==typeof e)return e;if("string"==typeof e)return-1===e.indexOf("/")?e:e.split("/").reverse().reduce((t,e,i,s)=>0===i?`$expand=${e}`:i===s.length-1?`${e}(${t})`:`$expand=${e}(${t})`,"");if(Array.isArray(e))return`${e.map(e=>t(e)).join(",")}`;if("object"==typeof e){const i=Object.keys(e);return i.some(t=>-1!==nt.indexOf(t.toLowerCase()))?i.map(i=>{const s=i===W.a.filter?ct(e[i]):i===W.a.orderby?lt(e[i]):t(e[i]);return`$${i.toLowerCase()}=${s}`}).join(";"):i.map(i=>{const s=t(e[i]);return s?`${i}(${s})`:i}).join(",")}}(c);u.$expand=t}if(r)throw new Error("Should use Entity.count() to get the amount");return function(t,e){return Object.keys(e).length?t+"?"+Object.keys(e).map(t=>`${t}=${e[t]}`).join("&"):t}("",u)};function ct(t={},e=""){if(!t)return null;if("string"==typeof t)return t;if(!Array.isArray(t)){if("object"==typeof t){return Object.keys(t).reduce((i,s)=>{const r=t[s],n=e?at.test(s)?s.replace(at,`(${e}/$1)`):`(${e}/${s}`:s;if(-1!==["number","string","boolean"].indexOf(typeof r)||r instanceof Date||null===r)i.push(`${n} eq ${ut(r)}`);else if(Array.isArray(r)){const t=s,n=r.map(t=>ct(t,e)).filter(t=>void 0!==t).map(e=>-1!==it.indexOf(t)?`(${e})`:e);n.length&&(-1!==it.indexOf(t)?n.length&&(t===W.a.not?i.push(function(t,e){return e.length>1?`not( ${e.join(" and ")})`:e.map(t=>"("===t.charAt(0)?"(not ".concat(t.substr(1)):"not ".concat(t))}(0,n)):i.push(`(${n.join(` ${t} `)})`)):i.push(n.join(` ${t} `)))}else if(r instanceof Object)if("type"in r)i.push(`${n} eq ${ut(r)}`);else{Object.keys(r).forEach(t=>{if(-1!==et.indexOf(t))if(t===W.a.like){const e="%"===r[t][r[t].length-1],s="%"===r[t][0],o=a.a.replace(r[t],/%/g,"");let c;e&&s?c="contains":e?c="startswith":s&&(c="endswith"),c?i.push(`${c}(${n},${ut(o)})`):i.push(`${n} ${ut(o)}`)}else i.push(`${n} ${t} ${ut(r[t])}`);else if(-1!==it.indexOf(t))Array.isArray(r[t])?i.push(r[t].map(t=>"("+ct(t,n)+")").join(` ${t} `)):i.push("("+ct(r[t],n)+")");else if(-1!==st.indexOf(t)){const e=s[0].toLowerCase(),a=ct(r[t],e);void 0!==a&&i.push(`${n}/${t}(${e}:${a})`)}else if(t===W.a.in){const e=Array.isArray(r[t])?r[t]:r[t].value.map(e=>({type:r[t].type,value:e}));i.push("("+e.map(t=>`${n} eq ${ut(t)}`).join(" or ")+")")}else-1!==rt.indexOf(t)?i.push(`${t}(${n},${ut(r[t])})`):i.push(ct(r,n))})}else if(void 0!==r)throw new Error(`Unexpected value type: ${r}`);return i},[]).join(" and ")||void 0}throw new Error(`Unexpected filters type: ${t}`)}{const e=t.map(t=>ct(t).filter(t=>void 0!==t));if(e.length)return`${e.map(t=>`(${t})`).join(" and ")}`}}function ut(t){if("string"==typeof t)return`'${e=t,e=(e=(e=(e=(e=(e=(e=e.replace(/%/g,"%25")).replace(/\+/g,"%2B")).replace(/\//g,"%2F")).replace(/\?/g,"%3F")).replace(/#/g,"%23")).replace(/&/g,"%26")).replace(/'/g,"''")}'`;if(t instanceof Date)return t.toISOString();if(t instanceof Number)return t;if(Array.isArray(t)){return`[${t.map(t=>"string"==typeof t?`'${t}'`:t).join(",")}]`}switch(t&&t.type){case"guid":case"raw":return t.value}return t;var e}function lt(t){if("number"==typeof t)return t;if("string"==typeof t)return t;if(Array.isArray(t)){if(2===t.length&&"string"==typeof t[0]&&"string"==typeof t[1])return t.join(" ");{let e=[];return t.map(t=>{"string"==typeof t?e.push(t):e.push(t.join(" "))}),e.join(",")}}}console.log;const ht=[W.a.eq,W.a.ne,W.a.gt,W.a.ge,W.a.lt,W.a.le,W.a.like],dt=[W.a.and,W.a.or,W.a.not],pt=[W.a.any,W.a.all],ft=[W.a.startsWith,W.a.endsWith,W.a.contains],yt=(W.a.expand,W.a.select,W.a.top,W.a.orderby,W.a.filter,/\((.*)\)/);var mt=function(t){let{filter:e,where:i,limit:s,count:n}=t;const o={};if(i=Object.assign({},i,e)){const t=gt(i);t&&(o.$filter=t)}if(s){const t=function(t){return a.a.isInteger(t)&&t>0&&t}(s);t&&(o.$top=t)}return n&&(o.$count="boolean"==typeof n?"COUNT(*)":"COUNT(*) AS "+n),function(t,e){if(t.type===r.a.SELECT){let i="SELECT ";return e.$count?i+=e.$count:e.$select||(i+=" * "),i+=" FROM "+t.entity.tableName,e.$filter&&(i+=" WHERE "+e.$filter),i}}(t,o)};function gt(t={},e=""){if(!t)return null;if("string"==typeof t)return t;if(!Array.isArray(t)){if("object"==typeof t){return Object.keys(t).reduce((i,s)=>{const r=t[s],n=e?yt.test(s)?s.replace(yt,`(${e}/$1)`):`(${e}/${s}`:s;if(-1!==["number","string","boolean"].indexOf(typeof r)||r instanceof Date||null===r)i.push(`${n} = ${bt(r)}`);else if(Array.isArray(r)){const t=s,n=r.map(t=>gt(t,e)).filter(t=>void 0!==t).map(e=>-1!==dt.indexOf(t)?`(${e})`:e);n.length&&(-1!==dt.indexOf(t)?n.length&&(t===W.a.not?i.push(function(t,e){return e.length>1?`not( ${e.join(" and ")})`:e.map(t=>"("===t.charAt(0)?"(not ".concat(t.substr(1)):"not ".concat(t))}(0,n)):i.push(`(${n.join(` ${t} `)})`)):i.push(n.join(` ${t} `)))}else if(r instanceof Object)if("type"in r)i.push(`${n} = ${bt(r)}`);else{Object.keys(r).forEach(t=>{if(-1!==ht.indexOf(t))W.a.like,i.push(`${n} ${t} ${bt(r[t])}`);else if(-1!==dt.indexOf(t))Array.isArray(r[t])?i.push(r[t].map(t=>"("+gt(t,n)+")").join(` ${t} `)):i.push("("+gt(r[t],n)+")");else if(-1!==pt.indexOf(t)){const e=s[0].toLowerCase(),a=gt(r[t],e);void 0!==a&&i.push(`${n}/${t}(${e}:${a})`)}else if(t===W.a.in){const e=Array.isArray(r[t])?r[t]:r[t].value.map(e=>({type:r[t].type,value:e}));i.push("("+e.map(t=>`${n} = ${bt(t)}`).join(" or ")+")")}else-1!==ft.indexOf(t)?i.push(`${t}(${n},${bt(r[t])})`):i.push(gt(r,n))})}else if(void 0!==r)throw new Error(`Unexpected value type: ${r}`);return i},[]).join(" and ")||void 0}throw new Error(`Unexpected filters type: ${t}`)}{const e=t.map(t=>gt(t).filter(t=>void 0!==t));if(e.length)return`${e.map(t=>`(${t})`).join(" and ")}`}}function bt(t){if("string"==typeof t)return`'${e=t,e}'`;if(t instanceof Date)return t.toISOString();if(t instanceof Number)return t;if(Array.isArray(t)){return`[${t.map(t=>"string"==typeof t?`'${t}'`:t).join(",")}]`}switch(t&&t.type){case"guid":case"raw":return t.value}return t;var e}var wt=i(7),At=i.n(wt);console.log;const Et=L.debug,_t={};class vt{constructor(t,e){e=e||{},this.odata=t,this.rootUrl=t.rootUrl||e.rootUrl,_t[this.rootUrl]?this.cache=_t[this.rootUrl]:this.cache=_t[this.rootUrl]={},this.instance=e.instance,this.entity=e.entity,this.options=Object.assign({plain:!1,raw:!1},e)}async run(t,e){let{sql:i,entity:s,type:n}=t;if(n===r.a.SELECT){let t=this.rootUrl;const e=s&&s.name?s.name:null;if(!e)throw new Error("Should not use this sectionsql:"+i);s.is_custom_table&&(t+="CUSTOMTABLE/"),t+=s.name+i;const r=(await this.get(t)).value;return e?this.formatResults(r):r}if(n===r.a.INSERT){let t=this.rootUrl;return(s&&s.name?s.name:null)&&(s.is_custom_table&&(t+="CUSTOMTABLE/"),t+=s.name),await this._insertEntity(t,e)}if(n!==r.a.UPDATE){if(n===r.a.DELETE){const{instance:e}=t;let i=e.getODataValue("editLink"),s=e.getODataValue("etag");if(!i)throw new Error("There is no editLink url for update.");return await this._deleteEntity(i,s)}throw new Error("The type["+n+"] has not been implemented in odbc/handler.js")}{const{instance:i}=t;i.getPrimaryKeyAttribute();i.getPrimaryKey();let s=i.getODataValue("editLink"),r=i.getODataValue("etag");try{if(!s)throw new Error("There is no editLink url for update.");return await this._updateEntity(s,e,r)}catch(t){throw t.is_etag?new Error("Your data has been updated by another person, please refresh the page and try again."):t}}}async _insertEntity(t,e){return await this.post(t,{body:JSON.stringify(e)})}async _updateEntity(t,e,i){const s={};return i&&(s["If-Match"]=i),await this.post(t,{method:"PATCH",headers:s,body:JSON.stringify(e)})}async _deleteEntity(t,e){const i={};return e&&(i["If-Match"]=e),await this.post(t,{method:"DELETE",headers:i})}async getEntityData(t,e=!0){if(e&&this.cache[t])return this.cache[t];let i=this.rootUrl+t;const s=await this.get(i);return e&&(this.cache[t]=s),s}async postDataToAccredo(t,e){let i=this.rootUrl+t;return await this.post(i,{body:JSON.stringify(e)})}async getEntityXML(t,e=!0){if(e&&this.cache[t])return this.cache[t];let i=this.rootUrl+t;const s=await At()(i),r=await s.text();if(r.error)throw r.error;return r}async executeSql(t){const e=this.rootUrl+"ExecuteSQL";return(await this.post(e,{body:JSON.stringify({QueryText:t})})).value}formatResults(t){let e=this.instance;if(!this.isInsertQuery(t)){if(this.isSelectQuery())return this.handleSelectQuery(t);throw new Error("handler.js formatResult not implemented. ["+this.options.type+"]")}return e}async get(t){try{const e={format:"odata.metadata=full"},i=await this.odata.accredo.getTokens();i&&(e.Authorization="Bearer "+i.access_token),Et("--- BEGIN GET REQUEST----------"),Et("url",t),Et("headers",e);let s=t,r=null,n=null,o=null,c=0;for(;s;){if(c++,o=await At()(s,{headers:e}),n=await o.json(),Et("url_i: ",c,"tmp_url: ",s," res:",n),n.error)throw n.error;null===r?r=a.a.cloneDeep(n):r.value=r.value.concat(n.value),s=n["@odata.nextLink"]}return Et("--- END GET REQUEST----------"),r}catch(t){let e="";throw"string"==typeof t?e=t:(e=t.message,Array.isArray(t.details)&&t.details.map(t=>{e+=" [ Code("+t.code+") - "+t.message+" ] "})),new Error(e)}}async post(t,e){try{Et("httpRequest[post]:",t,e),e=e||{};let{headers:i,...s}=e;i=Object.assign({"Content-Type":"application/json",format:"odata.metadata=full"},i||{});const r=await this.odata.accredo.getTokens();r&&(i.Authorization="Bearer "+r.access_token),Et("--- BEGIN POST REQUEST----------"),Et("url",t),Et("headers",i),s=Object.assign({method:"POST",headers:i},s||{});const n=await At()(t,s),a=await n.json();if(Et("data",a),Et("---- END POST REQUEST---------"),a.error)throw a.error;return a}catch(t){let e=!1,i=t.message;Array.isArray(t.details)&&t.details.map(t=>{i+=" [ Code("+t.code+") - "+t.message+" ] ",-1===t.message.indexOf("If-Match")&&-1===t.message.indexOf("etag")||(e=!0)});const s=new Error(i);throw s.is_etag=e,s}}isSelectQuery(){return this.options.type===r.a.SELECT}handleSelectQuery(t){let e=null;if(this.options.fieldMap){const e=this.options.fieldMap;t=t.map(t=>a.a.reduce(e,(t,e,i)=>(void 0!==t[i]&&(t[e]=t[i],delete t[i]),t),t))}if(this.options.raw)throw Et("results",t),new Error("handler.js raw is not implemented");if(!0===this.options.hasJoin)throw new Error("handler.js hasJoin is not implemented");return e=this.entity.bulkBuild(t,{isNewRecord:!1,raw:!0,attributes:this.options.originalAttributes||this.options.attributes,expand:this.options.expand||null}),this.options.plain&&(e=0===e.length?null:e[0]),e}isInsertQuery(t,e){let i=!0;return this.options.type===r.a.INSERT||(i=(i=(i=i&&this.options.sql.toLowerCase().startsWith("insert into"))&&(!t||t.hasOwnProperty(this.getInsertIdField())))&&(!e||e.hasOwnProperty(this.getInsertIdField())))}getInsertIdField(){return"insertId"}}console.log;class Ot{constructor(t){this.accredo=t,this.rootUrl=t.rootUrl}select(t,e){(e=L.cloneDeep(e)).type=r.a.SELECT,e.entity=t;const i=ot(e);return e.sql=i,this.accredo.query(i,e)}async count(t,e){(e=L.cloneDeep(e)).type=r.a.SELECT,e.entity=t,e.count=!0;const i=mt(e),s=await this.accredo.executeSql(i),n=s?Object.values(s[0]):0;return Array.isArray(n)?n[0]:0}async insert(t,e,i){return(i=L.cloneDeep(i)).hasTrigger=t&&t.constructor.options.hasTrigger,i.type=r.a.INSERT,i.instance=t,await this.accredo.insert(t,e,i)}async update(t,e,i,s){return(s=L.cloneDeep(s)).hasTrigger=t&&t.constructor.options.hasTrigger,s.type=r.a.INSERT,s.instance=t,await this.accredo.update(t,e,i,s)}async delete(t,e){return(e=a.a.clone(e)||{}).type=r.a.DELETE,e.instance=t,await this.accredo.delete(t,e)}getConnection(t){return new vt(this,t)}rawSelect(t,e,i){e=L.cloneDeep(e),e=a.a.defaults(e,{raw:!0,plain:!0,type:r.a.SELECT,entity:t});const s=ot(e);if(e.sql=s,void 0===i)throw new Error("Please pass an attribute selector!");return this.accredo.query(s,e).then(t=>{if(!e.plain)return t;const s=t?t[i]:null;if(!e||!e.dataType)return s;const r=e.dataType;return(r instanceof DataTypes.DECIMAL||r instanceof DataTypes.FLOAT)&&null!==s?parseFloat(s):r instanceof DataTypes.INTEGER||r instanceof DataTypes.BIGINT?parseInt(s,10):r instanceof DataTypes.DATE&&null!==s&&!(s instanceof Date)?new Date(s):s})}static get Handler(){return vt}}var It=i(16),jt=i.n(It),xt=i(8),kt=i.n(xt);console.log;class Dt{constructor(t,e){e=e||{},"object"==typeof t&&(t=(e=t).url),this.rootUrl=t,this.cache={};const i={rootUrl:t};Dt.runHooks("beforeInit",i,e),this.options=Object.assign({hooks:{},define:{}},e),this._setupHooks(e.hooks),this.config=i,this.entities={},this.entityManager=new tt.a(this),this.connectionManager=new Ot(this),Dt.runHooks("afterInit",this)}async getTokens(){const{token_url:t,client_id:e,username:i,password:s,cache_dir:r}=this.options;if(!(t&&e&&i&&s&&r))return null;const n="token_"+e+"_"+i+"_"+s,a=jt.a.join(r,n);let o=0;if(kt.a.existsSync(a)){let t=kt.a.statSync(a).mtimeMs;const e=kt.a.readFileSync(a),i=JSON.parse(e);if((o=t+1e3*i.expires_in)>Date.now())return i}const c=await At()(t,{method:"POST",body:JSON.stringify({grant_type:"password",client_id:e,username:i,password:s})}),u=await c.json();if(u.error){const t=new Error;throw t.code=u.error+u.error_description,t.message=u.error+u.error_description,t}return kt.a.writeFileSync(a,JSON.stringify(u)),o=Date.now()+u.expires_in,u.timeTo=new Date(o),u}fetchFunction(){}async About(){return await this.about()}async about(){return await this.getEntityData("About")}async Version(){return await this.version()}async version(){return(await this.about()).Version}async Company(){return await this.company()}async company(){return await this.getEntityData("Company")}async SystemPeriod(){return await this.systemPeriod()}async systemPeriod(){const t=await this.getEntityData("SystemPeriod");return"object"==typeof t?t.SystemPeriod:null}async SystemDate(){return await this.systemDate()}async systemDate(){const t=await this.getEntityData("SystemDate");return"object"==typeof t?t.SystemDate:null}async CurrentUser(){return await this.currentUser()}async currentUser(){return await this.getEntityData("User")}define(t,e,i={}){i.entityName=t,i.accredo=this;const s=class extends X{};return s.init(e,i),s}entity(t){if(!this.isDefined(t))throw new Error(`${t} has not been defined`);return this.entityManager.getEntity(t)}isDefined(t){return!!this.entityManager.entities.find(e=>e.name===t)}normalizeDataType(t){return"function"==typeof t?new t:t}normalizeAttribute(t){return a.a.isPlainObject(t)||(t={type:t}),t.type?(t.type=this.normalizeDataType(t.type),t.hasOwnProperty("defaultValue")&&"function"==typeof t.defaultValue&&(t.defaultValue=new t.defaultValue),t):t}getQueryInterface(){return this.odataInterface=this.odataInterface||new Ot(this),this.odataInterface}async sql(t){const e=await this.executeSql(t);return 0===Object.keys(e).length&&e.constructor===Object?null:e}async sqlRow(t,e){e||(e=0);const i=await this.sql(t);return Array.isArray(i)&&i.length>e?i[e]:null}async sqlOne(t,e){const i=await this.sqlRow(t);return i?(e||(e=Object.keys(i)[0]),i[e]):null}async executeSql(t){const e=this.connectionManager.getConnection();return await this.runHooks("beforeQuery",{}),await e.executeSql(t)}async getEntityData(t,e=!0){const i=this.connectionManager.getConnection();return await i.getEntityData(t,e)}async postDataToAccredo(t,e){const i=this.connectionManager.getConnection();return await i.postDataToAccredo(t,e)}async getEntityXML(t,e=!0){const i=this.connectionManager.getConnection();return await i.getEntityXML(t,e)}async query(t,e){if((e=Object.assign({},this.options.query,e)).instance&&!e.entity&&(e.entity=e.instance.constructor),e.instance||e.entity||(e.raw=!0),e.mapToEntity&&(e.fieldMap=a.a.get(e,"entity.fieldAttributeMap",{})),(e=a.a.defaults(e,{logging:this.options.hasOwnProperty("logging")?this.options.logging:console.log,searchPath:this.options.hasOwnProperty("searchPath")?this.options.searchPath:"DEFAULT"})).type||(e.entity||e.nest||e.plain?e.type=r.a.SELECT:e.type=r.a.RAW),"object"==typeof t){if(void 0!==t.values){if(void 0!==e.replacements)throw new Error("Both `sql.values` and `options.replacements` cannot be set at the same time");e.replacements=t.values}if(void 0!==t.bind){if(void 0!==e.bind)throw new Error("Both `sql.bind` and `options.bind` cannot be set at the same time");e.bind=t.bind}void 0!==t.query&&(t=t.query)}if(t=t.trim(),e.sql=t,e.transaction&&e.transaction.finished){const i=new Error(`${e.transaction.finished} has been called on this transaction(${e.transaction.id}), you can no longer use it. (The rejected query is attached as the 'sql' property of this error)`);throw i.sql=t,i}const i=await e.transaction?e.transaction.connection:this.connectionManager.getConnection(e);if(await this.runHooks("beforeQuery",e),i instanceof Ot.Handler){return await i.run(e)}throw new Error("Not implemented in accredo.query()")}async insert(t,e,i){(i=Object.assign({},this.options.query,i)).instance&&!i.entity&&(i.entity=i.instance.constructor),i.instance||i.entity||(i.raw=!0),i.mapToEntity&&(i.fieldMap=a.a.get(i,"entity.fieldAttributeMap",{})),(i=a.a.defaults(i,{logging:this.options.hasOwnProperty("logging")?this.options.logging:console.log,searchPath:this.options.hasOwnProperty("searchPath")?this.options.searchPath:"DEFAULT"})).type=r.a.INSERT;const s=await this.connectionManager.getConnection(i);return await this.runHooks("beforeQuery",i),await s.run(i,e)}async update(t,e,i){(i=a.a.clone(i||{})).hasTrigger=!!(t&&t._entityOptions&&t._entityOptions.hasTrigger),i.instance=t,i.instance&&!i.entity&&(i.entity=i.instance.constructor),i.type=r.a.UPDATE;const s=await this.connectionManager.getConnection(i);return await this.runHooks("beforeQuery",i),await s.run(i,e)}async delete(t,e){(e=a.a.clone(e||{})).hasTrigger=!!(t&&t._entityOptions&&t._entityOptions.hasTrigger),e.instance=t,e.instance&&!e.entity&&(e.entity=e.instance.constructor),e.type=r.a.DELETE;const i=await this.connectionManager.getConnection(e);return await this.runHooks("beforeQuery",e),await i.run(e)}static fn(t,...e){return new L.Fn(t,e)}static col(t){return new L.Col(t)}static cast(t,e){return new L.Cast(t,e)}static literal(t){return new L.Literal(t)}static and(...t){return{[W.a.and]:t}}static or(...t){return{[W.a.or]:t}}static json(t,e){return new L.Json(t,e)}static where(t,e,i){return new L.Where(t,e,i)}authenticate(t){return B.a.resolve(()=>!0)}}Dt.prototype.fn=Dt.fn,Dt.prototype.col=Dt.col,Dt.prototype.cast=Dt.cast,Dt.prototype.literal=Dt.literal,Dt.prototype.and=Dt.and,Dt.prototype.or=Dt.or,Dt.prototype.json=Dt.json,Dt.prototype.where=Dt.where,Dt.prototype.validate=Dt.prototype.authenticate,Dt.options={hooks:{}},Dt.prototype.Accredo=Dt,Dt.Entity=X,Dt.DataTypes=j;for(const t in j)Dt[t]=j[t];c.a.applyTo(Dt),c.a.applyTo(Dt.prototype);var St=Dt;i.d(e,"Accredo",function(){return St}),i.d(e,"Entity",function(){return X}),i.d(e,"Op",function(){return W.a});e.default=St}]);
